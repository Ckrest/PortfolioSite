# vcsh support for git operations

title: vcsh support for git operations
summary: Added vcsh support so git operations work in the Systems repo. The project name (--project) is now used to detect
  and use the corresponding vcsh repo for git commands.
date: '2026-01-30'
tags:
- Bug Fix
- Python
status: in-progress
size: medium
linkTo: detail
description: Added vcsh support so git operations work in the Systems repo. The project name (--project) is now used to detect
  and use the corresponding vcsh repo for git commands.
source:
  report_id: 49
  duration_hours: 0.5
  effort: medium
  commit: a9f4eb834bd1bf32b7949e4d3bd38b29e187319a
content:
  blocks:
  - id: blk_b935b7b2
    type: code
    language: diff
    code: "diff --git a/evidence/handlers/git_diff.py b/evidence/handlers/git_diff.py\nindex 18e720d..74e906d 100644\n---\
      \ a/evidence/handlers/git_diff.py\n+++ b/evidence/handlers/git_diff.py\n@@ -21,7 +21,11 @@ from evidence import (\n\
      \ \n \n class GitDiffHandler(EvidenceHandler):\n-    \"\"\"Handler for git diff evidence.\"\"\"\n+    \"\"\"Handler\
      \ for git diff evidence.\n+\n+    Supports both standard git repos and vcsh repos.\n+    For vcsh, uses context.project\
      \ to find the right repo.\n+    \"\"\"\n \n     name = \"git_diff\"\n     display_name = \"Git Changes\"\n@@ -31,9 +35,10\
      \ @@ class GitDiffHandler(EvidenceHandler):\n         \"\"\"Find git changes: uncommitted work and the specified commit.\"\
      \"\"\n         evidence = []\n         work_dir = context.work_dir or Path.cwd()\n+        vcsh_repo = self._detect_vcsh_repo(context.project)\n\
      \ \n         # Check for uncommitted changes\n-        uncommitted = self._get_uncommitted_diff(work_dir)\n+       \
      \ uncommitted = self._get_uncommitted_diff(work_dir, vcsh_repo)\n         if uncommitted:\n             # Get summary\
      \ stats for label\n             stats = self._get_diff_stats(uncommitted)\n@@ -50,11 +55,11 @@ class GitDiffHandler(EvidenceHandler):\n\
      \ \n         # If a commit is specified, get that commit's diff\n         if context.commit:\n-            commit_diff\
      \ = self._get_commit_diff(work_dir, context.commit)\n+            commit_diff = self._get_commit_diff(work_dir, context.commit,\
      \ vcsh_repo)\n             if commit_diff:\n                 short_hash = context.commit[:8]\n                 stats\
      \ = self._get_diff_stats(commit_diff)\n-                message = self._get_commit_message(work_dir, context.commit)\n\
      +                message = self._get_commit_message(work_dir, context.commit, vcsh_repo)\n                 evidence.append(Evidence(\n\
      \                     handler_name=self.name,\n                     key=f\"commit-{short_hash}\",\n@@ -70,6 +75,30 @@\
      \ class GitDiffHandler(EvidenceHandler):\n \n         return evidence\n \n+    def _detect_vcsh_repo(self, project:\
      \ str) -> str | None:\n+        \"\"\"Detect if project corresponds to a vcsh repo.\n+\n+        Returns repo name if\
      \ found, None otherwise.\n+        \"\"\"\n+        if not project:\n+            return None\n+\n+        # Check if\
      \ vcsh repo exists with this name\n+        try:\n+            result = subprocess.run(\n+                [\"vcsh\"\
      , \"list\"],\n+                capture_output=True,\n+                text=True,\n+                timeout=5,\n+   \
      \         )\n+            repos = result.stdout.strip().split('\\n')\n+            if project in repos:\n+         \
      \       return project\n+        except (subprocess.CalledProcessError, subprocess.TimeoutExpired, FileNotFoundError):\n\
      +            pass\n+\n+        return None\n+\n     def capture(self, evidence: Evidence, report_dir: Path) -> CapturedArtifact:\n\
      \         \"\"\"Write diff content to a .diff file in the report directory.\"\"\"\n         if not evidence.content:\n\
      @@ -106,50 +135,33 @@ class GitDiffHandler(EvidenceHandler):\n             \"content\": artifact.get(\"content\", \"\
      \"),\n         }\n \n-    def _get_uncommitted_diff(self, work_dir: Path) -> str | None:\n-        \"\"\"Get diff of\
      \ all uncommitted changes (staged + unstaged).\"\"\"\n+    def _run_git(self, args: list[str], work_dir: Path, vcsh_repo:\
      \ str | None, timeout: int = 30) -> str | None:\n+        \"\"\"Run a git command, using vcsh if specified.\"\"\"\n\
      \         try:\n-            # Get both staged and unstaged changes\n-            result = subprocess.run(\n-      \
      \          [\"git\", \"diff\", \"HEAD\"],\n-                capture_output=True,\n-                text=True,\n-   \
      \             cwd=work_dir,\n-                timeout=30,\n-            )\n-            diff = result.stdout.strip()\n\
      -            return diff if diff else None\n+            if vcsh_repo:\n+                cmd = [\"vcsh\", vcsh_repo]\
      \ + args\n+                result = subprocess.run(cmd, capture_output=True, text=True, timeout=timeout)\n+        \
      \    else:\n+                cmd = [\"git\"] + args\n+                result = subprocess.run(cmd, capture_output=True,\
      \ text=True, cwd=work_dir, timeout=timeout)\n+            return result.stdout.strip() if result.returncode == 0 else\
      \ None\n         except (subprocess.CalledProcessError, subprocess.TimeoutExpired, FileNotFoundError):\n           \
      \  return None\n \n-    def _get_commit_diff(self, work_dir: Path, commit: str) -> str | None:\n+    def _get_uncommitted_diff(self,\
      \ work_dir: Path, vcsh_repo: str | None = None) -> str | None:\n+        \"\"\"Get diff of all uncommitted changes (staged\
      \ + unstaged).\"\"\"\n+        diff = self._run_git([\"diff\", \"HEAD\"], work_dir, vcsh_repo)\n+        return diff\
      \ if diff else None\n+\n+    def _get_commit_diff(self, work_dir: Path, commit: str, vcsh_repo: str | None = None) ->\
      \ str | None:\n         \"\"\"Get diff for a specific commit.\"\"\"\n-        try:\n-            result = subprocess.run(\n\
      -                [\"git\", \"diff\", f\"{commit}~1..{commit}\"],\n-                capture_output=True,\n-         \
      \       text=True,\n-                cwd=work_dir,\n-                timeout=30,\n-            )\n-            diff\
      \ = result.stdout.strip()\n-            return diff if diff else None\n-        except (subprocess.CalledProcessError,\
      \ subprocess.TimeoutExpired, FileNotFoundError):\n-            return None\n+        diff = self._run_git([\"diff\"\
      , f\"{commit}~1..{commit}\"], work_dir, vcsh_repo)\n+        return diff if diff else None\n \n-    def _get_commit_message(self,\
      \ work_dir: Path, commit: str) -> str:\n+    def _get_commit_message(self, work_dir: Path, commit: str, vcsh_repo: str\
      \ | None = None) -> str:\n         \"\"\"Get the commit message for a commit.\"\"\"\n-        try:\n-            result\
      \ = subprocess.run(\n-                [\"git\", \"log\", \"-1\", \"--format=%s\", commit],\n-                capture_output=True,\n\
      -                text=True,\n-                cwd=work_dir,\n-                timeout=10,\n-            )\n-       \
      \     return result.stdout.strip()\n-        except (subprocess.CalledProcessError, subprocess.TimeoutExpired, FileNotFoundError):\n\
      -            return \"\"\n+        msg = self._run_git([\"log\", \"-1\", \"--format=%s\", commit], work_dir, vcsh_repo,\
      \ timeout=10)\n+        return msg or \"\"\n \n     def _get_diff_stats(self, diff_content: str) -> str:\n         \"\
      \"\"Parse diff to get stats summary like '3 files, +50/-10'.\"\"\"\ndiff --git a/work_report.py b/work_report.py\nindex\
      \ 9bdff5c..c1b9326 100755\n--- a/work_report.py\n+++ b/work_report.py\n@@ -305,10 +305,10 @@ class WorkReport:\n \n\
      \         # Get commit hash if not provided\n         if commit is None:\n-            commit = self._get_current_commit()\n\
      +            commit = self._get_current_commit(project)\n \n         # Auto-capture git stats\n-        files_changed,\
      \ lines_added, lines_removed, diff_stat = self._get_git_stats(commit)\n+        files_changed, lines_added, lines_removed,\
      \ diff_stat = self._get_git_stats(commit, project)\n \n         # Get work start time for evidence discovery\n     \
      \    work_start = self._get_work_start_time()\n@@ -993,8 +993,13 @@ class WorkReport:\n         }\n         return mapping.get(file_type,\
      \ 'image')\n \n-    def _get_current_commit(self):\n-        \"\"\"Get current git commit hash.\"\"\"\n+    def _get_current_commit(self,\
      \ project: str = None):\n+        \"\"\"Get current git commit hash.\n+\n+        Supports both standard git repos and\
      \ vcsh repos.\n+        For vcsh, uses the project name to find the right repo.\n+        \"\"\"\n+        # Try standard\
      \ git first\n         try:\n             result = subprocess.run(\n                 [\"git\", \"rev-parse\", \"HEAD\"\
      ],\n@@ -1005,26 +1010,65 @@ class WorkReport:\n             )\n             return result.stdout.strip()\n         except\
      \ subprocess.CalledProcessError:\n-            return None\n+            pass\n+\n+        # Try vcsh if project name\
      \ provided\n+        if project:\n+            try:\n+                result = subprocess.run(\n+                  \
      \  [\"vcsh\", project, \"rev-parse\", \"HEAD\"],\n+                    capture_output=True,\n+                    text=True,\n\
      +                    check=True,\n+                )\n+                return result.stdout.strip()\n+            except\
      \ (subprocess.CalledProcessError, FileNotFoundError):\n+                pass\n \n-    def _get_git_stats(self, commit:\
      \ str) -> tuple:\n+        return None\n+\n+    def _get_git_stats(self, commit: str, project: str = None) -> tuple:\n\
      \         \"\"\"Get git diff stats for a commit.\n \n+        Supports both standard git repos and vcsh repos.\n   \
      \      Returns (files_changed, lines_added, lines_removed, diff_stat).\n         \"\"\"\n         if not commit:\n \
      \            return None, None, None, None\n \n+        def run_git(args):\n+            \"\"\"Run git command, falling\
      \ back to vcsh if needed.\"\"\"\n+            # Try standard git first\n+            try:\n+                result =\
      \ subprocess.run(\n+                    [\"git\"] + args,\n+                    capture_output=True,\n+            \
      \        text=True,\n+                    check=True,\n+                    cwd=SYSTEMS_ROOT,\n+                )\n\
      +                return result.stdout.strip()\n+            except subprocess.CalledProcessError:\n+               \
      \ pass\n+\n+            # Try vcsh if project provided\n+            if project:\n+                try:\n+         \
      \           result = subprocess.run(\n+                        [\"vcsh\", project] + args,\n+                      \
      \  capture_output=True,\n+                        text=True,\n+                        check=True,\n+              \
      \      )\n+                    return result.stdout.strip()\n+                except (subprocess.CalledProcessError,\
      \ FileNotFoundError):\n+                    pass\n+\n+            return None\n+\n         try:\n-            # Get\
      \ numstat (machine-readable)\n-            result = subprocess.run(\n-                [\"git\", \"diff\", \"--shortstat\"\
      , f\"{commit}~1..{commit}\"],\n-                capture_output=True,\n-                text=True,\n-               \
      \ check=True,\n-                cwd=SYSTEMS_ROOT,\n-            )\n-            shortstat = result.stdout.strip()\n\
      +            # Get shortstat (machine-readable)\n+            shortstat = run_git([\"diff\", \"--shortstat\", f\"{commit}~1..{commit}\"\
      ])\n \n             files_changed = None\n             lines_added = None\n@@ -1032,7 +1076,6 @@ class WorkReport:\n\
      \ \n             if shortstat:\n                 # Parse \"3 files changed, 50 insertions(+), 10 deletions(-)\"\n- \
      \               import re\n                 m_files = re.search(r\"(\\d+) file\", shortstat)\n                 m_add\
      \ = re.search(r\"(\\d+) insertion\", shortstat)\n                 m_del = re.search(r\"(\\d+) deletion\", shortstat)\n\
      @@ -1041,18 +1084,11 @@ class WorkReport:\n                 lines_removed = int(m_del.group(1)) if m_del else 0\n \n\
      \             # Get human-readable diffstat\n-            result = subprocess.run(\n-                [\"git\", \"diff\"\
      , \"--stat\", f\"{commit}~1..{commit}\"],\n-                capture_output=True,\n-                text=True,\n-   \
      \             check=True,\n-                cwd=SYSTEMS_ROOT,\n-            )\n-            diff_stat = result.stdout.strip()\
      \ or None\n+            diff_stat = run_git([\"diff\", \"--stat\", f\"{commit}~1..{commit}\"])\n \n             return\
      \ files_changed, lines_added, lines_removed, diff_stat\n \n-        except subprocess.CalledProcessError:\n+       \
      \ except Exception:\n             return None, None, None, None"
    filename: a9f4eb83.diff
    caption: Add vcsh support for git operations
